name: Build All On All Possible Platforms

# Also run on Tag created
on:
  schedule:
    - cron: '0 0 * * 1-5'
  push:
    branches: [main]
    tags:
      - "*"
  pull_request:
    branches: [main]

env:
  # update with the name of the main binary
  binary: dinosaur-game
  # Before enabling LFS, please take a look at GitHub's documentation for costs and quota limits:
  # https://docs.github.com/en/repositories/working-with-files/managing-large-files/about-storage-and-bandwidth-usage
  use_git_lfs: false

jobs:
  pre-release-check:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: ${{ env.use_git_lfs }}
          fetch-depth: 0 # Needed to check git history
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - name: Check if release is needed
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESULT=$(./just.ts check-should-release)
          echo "should_release=$RESULT" >> "$GITHUB_OUTPUT"
          echo "Release needed: $RESULT"
      - name: Get Version
        id: version
        run: |
          VERSION=$(./just.ts get-version)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"

  # Build for wasm
  release-wasm:
    needs: pre-release-check
    if: needs.pre-release-check.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: ${{ env.use_git_lfs }}
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: wasm32-unknown-unknown
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: ./just.ts install-wasm-deps
      - run: ./just.ts build-wasm
      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          CONFIG=""
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            CONFIG="wrangler.nightly.jsonc"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            CONFIG="wrangler.prod.jsonc"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            CONFIG="wrangler.main.jsonc"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CONFIG="wrangler.internal.jsonc"
          fi

          if [[ -n "$CONFIG" ]]; then
            echo "Deploying using config: $CONFIG"
            bunx wrangler deploy --config "$CONFIG"
          else
            echo "Skipping deployment for this event/ref: ${{ github.event_name }} / ${{ github.ref }}"
          fi

      - name: Verify Deployment
        run: |
          URL=""
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            URL="https://dino-nightly.lqxclqxc.com"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            URL="https://dino.lqxclqxc.com"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            URL="https://dino-test.lqxclqxc.com"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            URL="https://dino-internal.lqxclqxc.com"
          fi

          if [[ -n "$URL" ]]; then
            echo "Verifying deployment at $URL"
            echo "Sleeping for 10 seconds..."
            sleep 10
            echo "Fetching $URL..."
            RESPONSE=$(curl -s -f "$URL")
            if echo "$RESPONSE" | grep -q "<title>Dinosaur</title>"; then
              echo "Verification Successful: Found '<title>Dinosaur</title>'"
            else
              echo "Verification Failed: Did not find '<title>Dinosaur</title>'"
              echo "Response content:"
              echo "$RESPONSE"
              exit 1
            fi
          else
            echo "Skipping verification (no URL matched)"
          fi

  # Build for Linux
  release-linux:
    needs: pre-release-check
    if: needs.pre-release-check.outputs.should_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: ${{ env.use_git_lfs }}
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: x86_64-unknown-linux-gnu
      - run: ./just.ts install-linux-deps

      - name: Build and Package
        run: |
          ./just.ts build-native x86_64-unknown-linux-gnu
          ./just.ts package-native x86_64-unknown-linux-gnu --app-version ${{ needs.pre-release-check.outputs.version }}

      - name: Upload binaries to artifacts
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'schedule'
        uses: actions/upload-artifact@v4
        with:
          path: ${{ env.binary }}-linux-${{ needs.pre-release-check.outputs.version }}.zip
          name: linux
          retention-days: 1

  # Build for Windows
  release-windows:
    needs: pre-release-check
    if: needs.pre-release-check.outputs.should_release == 'true'
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: ${{ env.use_git_lfs }}
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: x86_64-pc-windows-msvc
      - uses: oven-sh/setup-bun@v1
      - run: bun install

      - name: Build and Package
        run: |
          ./just.ts build-native x86_64-pc-windows-msvc
          ./just.ts package-native x86_64-pc-windows-msvc --app-version ${{ needs.pre-release-check.outputs.version }}

      - name: Upload binaries to artifacts
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'schedule'
        uses: actions/upload-artifact@v4
        with:
          path: ${{ env.binary }}-windows-${{ needs.pre-release-check.outputs.version }}.zip
          name: windows
          retention-days: 1

  # Build for MacOS x86_64
  release-macOS-intel:
    needs: pre-release-check
    if: needs.pre-release-check.outputs.should_release == 'true'
    runs-on: macOS-latest

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: ${{ env.use_git_lfs }}
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: x86_64-apple-darwin
      - uses: oven-sh/setup-bun@v1
      - run: bun install

      - name: Build and Package
        run: |
          ./just.ts build-native x86_64-apple-darwin
          ./just.ts package-native x86_64-apple-darwin --app-version ${{ needs.pre-release-check.outputs.version }}

      - name: Upload binaries to artifacts
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'schedule'
        uses: actions/upload-artifact@v4
        with:
          path: ${{ env.binary }}-macOS-intel-${{ needs.pre-release-check.outputs.version }}.dmg
          name: macOS-intel
          retention-days: 1

  # Build for MacOS Apple Silicon
  release-macOS-apple-silicon:
    needs: pre-release-check
    if: needs.pre-release-check.outputs.should_release == 'true'
    runs-on: macOS-latest

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: ${{ env.use_git_lfs }}
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: aarch64-apple-darwin
      - uses: oven-sh/setup-bun@v1
      - run: bun install

      - name: Build and Package
        run: |
          ./just.ts build-native aarch64-apple-darwin
          ./just.ts package-native aarch64-apple-darwin --app-version ${{ needs.pre-release-check.outputs.version }}

      - name: Upload binaries to artifacts
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'schedule'
        uses: actions/upload-artifact@v4
        with:
          path: ${{ env.binary }}-macOS-apple-silicon-${{ needs.pre-release-check.outputs.version }}.dmg
          name: macOS-apple-silicon
          retention-days: 1
  release:
    needs: [pre-release-check, release-linux, release-windows, release-macOS-intel, release-macOS-apple-silicon]
    if: needs.pre-release-check.outputs.should_release == 'true' && (startsWith(github.ref, 'refs/tags/') || github.event_name == 'schedule')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      - name: Get Commit Message
        id: get_commit_message
        run: |
          {
            echo 'body<<EOF'
            git log -1 --pretty=%B
            echo EOF
          } >> "$GITHUB_OUTPUT"
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          name: Dino Game Nightly Build
          tag_name: ${{ needs.pre-release-check.outputs.version }}
          body: ${{ steps.get_commit_message.outputs.body }}
          files: |
            artifacts/linux/*.zip
            artifacts/windows/*.zip
            artifacts/macOS-intel/*.dmg
            artifacts/macOS-apple-silicon/*.dmg
