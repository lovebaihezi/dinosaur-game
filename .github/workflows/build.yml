name: Build All On All Possible Platforms

# Also run on Tag created
on:
  schedule:
    - cron: '0 0 * * 1-5'
  push:
    branches: [main]
    tags:
      - "*"
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  # update with the name of the main binary
  binary: dinosaur-game
  # Before enabling LFS, please take a look at GitHub's documentation for costs and quota limits:
  # https://docs.github.com/en/repositories/working-with-files/managing-large-files/about-storage-and-bandwidth-usage
  use_git_lfs: false

jobs:
  # Lint and format check for scripts
  lint-scripts:
    name: Lint Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            scripts/node_modules
          key: ${{ runner.os }}-bun-scripts-${{ hashFiles('scripts/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-scripts-
      - name: Install dependencies
        working-directory: scripts
        run: bun install --frozen-lockfile
      - name: Run lint
        working-directory: scripts
        run: bun run lint
      - name: Run format check
        working-directory: scripts
        run: bun run format
      - name: Run typecheck
        working-directory: scripts
        run: bun run typecheck

  pre-release-check:
    needs: lint-scripts
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: ${{ env.use_git_lfs }}
          fetch-depth: 0 # Needed to check git history
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - name: Check if release is needed
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESULT=$(./just.ts check-should-release)
          echo "should_release=$RESULT" >> "$GITHUB_OUTPUT"
          echo "Release needed: $RESULT"
      - name: Get Version
        id: version
        run: |
          VERSION=$(./just.ts get-version)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"

  # Build for wasm
  release-wasm:
    needs: pre-release-check
    if: needs.pre-release-check.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: ${{ env.use_git_lfs }}
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-wasm32-unknown-unknown-${{ hashFiles('**/Cargo.toml', '**/Cargo.lock') }}
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: wasm32-unknown-unknown
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: ./just.ts install-wasm-deps
      - run: ./just.ts install-wasm-opt
      - run: ./just.ts build-wasm
      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          CONFIG=$(./just.ts get-wrangler-config)
          if [[ -n "$CONFIG" ]]; then
            echo "Deploying using config: $CONFIG"
            bunx wrangler deploy --config "$CONFIG"
          else
            echo "Skipping deployment for this event/ref: ${{ github.event_name }} / ${{ github.ref }}"
          fi

      - name: Verify Deployment
        run: |
          URL=$(./just.ts get-verify-url)
          if [[ -n "$URL" ]]; then
            echo "Verifying deployment at $URL"
            echo "Sleeping for 10 seconds..."
            sleep 10
            echo "Fetching $URL..."
            RESPONSE=$(curl -s -f "$URL")
            if echo "$RESPONSE" | grep -q "<title>Dinosaur</title>"; then
              echo "Verification Successful: Found '<title>Dinosaur</title>'"
            else
              echo "Verification Failed: Did not find '<title>Dinosaur</title>'"
              echo "Response content:"
              echo "$RESPONSE"
              exit 1
            fi
          else
            echo "Skipping verification (no URL matched)"
          fi

  # Build for Linux
  release-linux:
    needs: pre-release-check
    if: needs.pre-release-check.outputs.should_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: ${{ env.use_git_lfs }}
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-x86_64-unknown-linux-gnu-${{ hashFiles('**/Cargo.toml', '**/Cargo.lock') }}
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: x86_64-unknown-linux-gnu
      - run: ./just.ts install-linux-deps

      - name: Build and Package
        run: |
          ./just.ts build-native x86_64-unknown-linux-gnu
          ./just.ts package-native x86_64-unknown-linux-gnu --app-version ${{ needs.pre-release-check.outputs.version }}

      - name: Upload binaries to artifacts
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'schedule'
        uses: actions/upload-artifact@v4
        with:
          path: ${{ env.binary }}-linux-${{ needs.pre-release-check.outputs.version }}.zip
          name: linux
          retention-days: 1

  # Build for Windows
  release-windows:
    needs: pre-release-check
    if: needs.pre-release-check.outputs.should_release == 'true'
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: ${{ env.use_git_lfs }}
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-x86_64-pc-windows-msvc-${{ hashFiles('**/Cargo.toml', '**/Cargo.lock') }}
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: x86_64-pc-windows-msvc
      - uses: oven-sh/setup-bun@v1
      - run: bun install

      - name: Build and Package
        run: |
          bun just.ts build-native x86_64-pc-windows-msvc
          bun just.ts package-native x86_64-pc-windows-msvc --app-version ${{ needs.pre-release-check.outputs.version }}

      - name: Upload binaries to artifacts
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'schedule'
        uses: actions/upload-artifact@v4
        with:
          path: ${{ env.binary }}-windows-${{ needs.pre-release-check.outputs.version }}.zip
          name: windows
          retention-days: 1

  # Build for MacOS Apple Silicon
  release-macOS-apple-silicon:
    needs: pre-release-check
    if: needs.pre-release-check.outputs.should_release == 'true'
    runs-on: macOS-latest

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: ${{ env.use_git_lfs }}
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-aarch64-apple-darwin-${{ hashFiles('**/Cargo.toml', '**/Cargo.lock') }}
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: aarch64-apple-darwin
      - uses: oven-sh/setup-bun@v1
      - run: bun install

      - name: Build and Package
        run: |
          ./just.ts build-native aarch64-apple-darwin
          ./just.ts package-native aarch64-apple-darwin --app-version ${{ needs.pre-release-check.outputs.version }}

      - name: Upload binaries to artifacts
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'schedule'
        uses: actions/upload-artifact@v4
        with:
          path: ${{ env.binary }}-macOS-apple-silicon-${{ needs.pre-release-check.outputs.version }}.dmg
          name: macOS-apple-silicon
          retention-days: 1
  release:
    permissions:
      actions: read
      contents: write
    needs: [pre-release-check, release-linux, release-windows, release-macOS-apple-silicon]
    if: needs.pre-release-check.outputs.should_release == 'true' && (startsWith(github.ref, 'refs/tags/') || github.event_name == 'schedule')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      - name: Get Commit Message
        id: get_commit_message
        run: |
          {
            echo 'body<<EOF'
            git log -1 --pretty=%B
            echo EOF
          } >> "$GITHUB_OUTPUT"
      - name: Determine Release Name
        id: release_name
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "name=Dino Game Nightly Build" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "name=Dino Game ${{ needs.pre-release-check.outputs.version }}" >> "$GITHUB_OUTPUT"
          else
            # Fallback for any other case (should not happen based on job conditions)
            echo "name=Dino Game ${{ needs.pre-release-check.outputs.version }}" >> "$GITHUB_OUTPUT"
          fi
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.release_name.outputs.name }}
          tag_name: ${{ needs.pre-release-check.outputs.version }}
          body: ${{ steps.get_commit_message.outputs.body }}
          files: |
            artifacts/linux/*.zip
            artifacts/windows/*.zip
            artifacts/macOS-apple-silicon/*.dmg
